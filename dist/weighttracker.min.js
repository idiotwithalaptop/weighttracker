/*! weighttracker 25-10-2014 */
function UserService(){tableSvc.createTableIfNotExists("userAuth",function(a){})}function AzureWeightService(){tableSvc.createTableIfNotExists("weight",function(a){})}var express=require("express"),path=require("path"),favicon=require("serve-favicon"),logger=require("morgan"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),cookieSession=require("cookie-session"),csrf=require("csurf"),routes=require("./routes/index"),app=express();app.set("views",path.join(__dirname,"views")),app.set("view engine","ejs"),app.use(logger("dev")),app.use(bodyParser.json()),app.use(cookieParser()),app.use(cookieSession({keys:["iwal1984","kyh@$8615"]})),app.use(csrf()),app.use(function(a,b,c){b.cookie("XSRF-TOKEN",a.csrfToken()),c()}),app.use(express.static(path.join(__dirname,"public"))),app.use("/",routes),app.use(function(a,b,c){var d=new Error("Not Found");d.status=404,c(d)}),"development"===app.get("env")&&app.use(function(a,b,c){c.status(a.status||500),c.render("error",{message:a.message,error:a})}),app.use(function(a,b,c){c.status(a.status||500),c.render("error",{message:a.message,error:a})}),module.exports=app,module.exports={google:{clientId:"456375033128-8in1opc1cju7adtqnh6vlgq6cpdoi3pc.apps.googleusercontent.com",clientSecret:"yCEAezYQlJDrifRhG4L6aIs3",redirectUrl:"postmessage"}};var azure=require("azure-storage"),tableSvc=azure.createTableService(),exports=module.exports;UserService.prototype.grantViewProfile=function(a,b){var c=azure.TableUtilities.entityGenerator,d={PartitionKey:c.String(a),RowKey:c.String(b)};tableSvc.insertEntity("weight",d,function(a){})},UserService.prototype.isAllowedToViewProfile=function(a,b,c){var d=(new azure.TableQuery).select(["result","date"]).where("PartitionKey eq ? and RowKey eq ?",a,b);tableSvc.queryEntities("userAuth",d,null,function(a,b){c(a?{error:!0,msg:"Error querying"}:{error:!1,result:b.entries.length>0})})},UserService.prototype.getSharedProfiles=function(a,b){var c=(new azure.TableQuery).select(["result","date"]).where("PartitionKey eq ?",a);tableSvc.queryEntities("userAuth",c,null,function(a,c){if(a)b({error:!0,msg:"Error querying"});else{for(var d=[],e=0;e<c.entries.length;e++){var f=c.entries[e];d.push(f.RowKey._)}b({error:!1,result:d})}})},exports.createUserService=function(){return new UserService};var azure=require("azure-storage"),WeighIn=require("../../domain/weighin"),tableSvc=azure.createTableService(),exports=module.exports;AzureWeightService.prototype.insertWeighIn=function(a,b){var c=azure.TableUtilities.entityGenerator,d={PartitionKey:c.String(a),RowKey:c.String((new Date).toJSON()),result:c.Double(b.result),date:c.DateTime(b.date)};tableSvc.insertEntity("weight",d,function(a){})},AzureWeightService.prototype.getWeighInsForUser=function(a,b){var c=(new azure.TableQuery).select(["result","date"]).where("PartitionKey eq ?",a);tableSvc.queryEntities("weight",c,null,function(a,c){if(a)b({error:!0,msg:"Error querying"});else{for(var d=[],e=0;e<c.entries.length;e++){var f=c.entries[e];d.push({result:f.result._,date:f.date._})}b({error:!1,result:d})}})},exports.createWeighInService=function(){return new AzureWeightService};var date,result,WeighIn=function(a,b){date=b,result=a};WeighIn.prototype={date:date,result:result},module.exports=WeighIn;var goldilocksApp=angular.module("goldilocksApp",["ngRoute","ngResource","highcharts-ng","ui.bootstrap","goldilocksControllers"]);goldilocksApp.config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/home.html"}).when("/progress",{templateUrl:"partials/progress.html"}).otherwise({redirectTo:"/"})}]);var goldilocksControllers=angular.module("goldilocksControllers",[]);goldilocksControllers.controller("HomeCtrl",["$scope","$http","$timeout",function(a,b,c){a.signInCallback=function(c){b.post("/auth/login",{authCode:c.code}).success(function(b){b.profile?a.$emit("login:success",{fullName:b.profile.displayName,avatarUrl:b.profile.image.url}):a.$emit("login:fail")}).error(function(){a.$emit("login:error")})},a.renderSignInButton=function(){if("undefined"!=typeof gapi){var b={callback:a.signInCallback};gapi.signin.render("signInButton",b)}c(a.renderSignInButton,500)},a.start=function(){a.renderSignInButton()},a.start()}]),goldilocksControllers.controller("MasterCtrl",["$scope","$location","$log",function(a,b,c){a.username=null,a.avatar=null,a.loginStatus=null,a.$on("login:success",function(d,e){a.username=e.fullName,a.avatar=e.avatarUrl,c.debug("Login Successful"),b.path("/progress")}),a.$on("login:fail",function(){a.loginStatus="failed",c.debug("Login Failed")}),a.$on("login:error",function(){a.loginStatus="Login Error",c.debug("Login Error")})}]),goldilocksControllers.controller("ProgressCtrl",["$scope","$modal","$timeout","WeighIns",function(a,b,c,d){a.progress=null,a.opened=!0,a.dt=new Date,a.minWeight=null,a.update=function(){$.snackbar({content:"Loading your progress..."}),d.getWeighIns(null,a.onSuccess,a.onFail)},a.onSuccess=function(b){$.snackbar({content:"Done"}),a.progress=b.data;for(var c=[],d=0;d<b.data.length;d++){var e=b.data[d],f=parseFloat(e.result);c.push([Date.parse(e.date),f]),(null===a.minWeight||f<a.minWeight)&&(a.minWeight=f)}a.chartConfig.series=[{name:"Weight History",data:c}],a.chartConfig.yAxis.min=a.minWeight},a.onFail=function(){$.snackbar({content:"Progress Loading failed"}),a.status="Fail"},a.start=function(){a.update()},a.start(),a.chartConfig={chart:{type:"spline"},title:{text:""},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e. %b",year:"%b"},title:{text:"Date"}},yAxis:{title:{text:"Weight (kg)"},min:0},tooltip:{pointFormat:"{series.name}: <b>{point.y}</b><br/>",valueSuffix:" cm",shared:!0}},a.openAddModal=function(){var c=b.open({templateUrl:"addModal.html",controller:"AddModalCtrl"});c.result.then(function(b){$.snackbar({content:"Saving ..."}),d.saveWeighIn(b,a.saveSuccess,a.saveError)},function(){})},a.saveSuccess=function(){$.snackbar({content:"Done."}),c(a.update,2e3)},a.saveError=function(){$.snackbar({content:"Error saving."})}}]),goldilocksControllers.controller("AddModalCtrl",["$scope","$modalInstance",function(a,b){a.today=new Date,a.dt=a.today,a.weight=null,a.clear=function(){a.dt=null},a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={formatYear:"yy",showWeeks:!1,maxDate:a.today},a.format="dd/MM/yyyy",a.submit=function(){b.close({result:a.weight,date:a.dt.toISOString()})},a.cancel=function(){b.dismiss("cancel")}}]),goldilocksApp.service("WeighIns",["$http",function(a){this.getWeighIns=function(b,c,d){var e="/api/weighIns";"undefined"!=typeof b&&b&&(e+="/"+b),a.get(e).success(c).error(d)},this.saveWeighIn=function(b,c,d){var e="/api/weighIns";a.post(e,b).success(c).error(d)}}]);var express=require("express"),router=express.Router(),weighIns=require("./weighIn"),users=require("./users");router.use("/weighIns",weighIns),router.use("/users",users),module.exports=router;var express=require("express"),router=express.Router(),userData=require("../../data/azure/users");router.use("/:userId",function(a,b,c){if("undefined"!=typeof a.session.userId&&a.session.userId==a.params.userId)c();else{a.session.error="Access denied!";var d=new Error("Access denied!");d.status=401,c(d)}}),router.get("/:userId",function(a,b){var c=userData.createUserService();c.getSharedProfiles(a.params.userId,function(a){b.json(a)})}),module.exports=router;var express=require("express"),router=express.Router(),data=require("../../data/azure/weight").createWeighInService(),WeighIn=require("../../domain/weighin");router.use(function(a,b,c){if("undefined"!=typeof a.session.userId&&a.session.userId)c();else{a.session.error="Access denied!";var d=new Error("Access denied!");d.status=404,c(d)}}),router.get("/",function(a,b){data.getWeighInsForUser(a.session.userId,function(a){b.json({data:a.result.sort(function(a,b){return a.date.getTime()-b.date.getTime()})})})}),router.post("/",function(a,b){var c=a.body;data.insertWeighIn(a.session.userId,c),b.json({message:"Weigh-In Captured"})}),module.exports=router;var express=require("express"),router=express.Router(),google=require("googleapis"),plus=google.plus("v1"),OAuth2=google.auth.OAuth2,conf=require("../conf"),userStore=require("../data/azure/users");router.get("/",function(a,b){b.json({result:"wacca"})}),router.post("/login",function(a,b){var c=new OAuth2(conf.google.clientId,conf.google.clientSecret,conf.google.redirectUrl);c.getToken(a.body.authCode,function(d,e){d||(c.setCredentials(e),plus.people.get({userId:"me",auth:c},function(c,d){if(!c){a.session.userId=d.id,b.json({profile:d});var e=userStore.createUserService();e.isAllowedToViewProfile(d.id,d.id,function(a){a.error===!1&&a.result===!0&&e.grantViewProfile(d.id,d.id)})}}))})}),module.exports=router;var express=require("express"),router=express.Router(),api=require("./api"),auth=require("./auth");router.use("/api",api),router.use("/auth",auth),router.get("/",function(a,b){b.render("index",{title:"Express",csrfToken:a.csrfToken()})}),module.exports=router;